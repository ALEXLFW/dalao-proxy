#!/usr/bin/env node

require('colors');
const readline = require('readline');
const baseConfig = require('../config');

const register = require('../src/plugin').register;
const {
    program,
    ConfigParser,
    parserEmitter,
    printWelcome,
    usePlugins,
    commands: Commands,
} = require('../src');

printWelcome(baseConfig.version);


let runtimeConfig,
    proxySever;

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

parserEmitter.on('config:parsed', function (config) {
    program.context.config = runtimeConfig = config;
    usePlugins(program, runtimeConfig);

    register._trigger('config', config, value => {
        program.context.config = value;

        if (config.debug) {
            console.log('> parsed user configuration'.yellow)
            console.log(program.context.config);
        }
    });

    program.parse(process.argv);
});

// Command: Start
program.use(Commands.start, function (server) {
    program.context.server = proxySever = server;
});

// Command: Init
program.use(Commands.init);

// Command: Add-plugin
program.use(Commands.addPlugin);

program.use(function () {
    program
        .on('command:*', function () {
            program.outputHelp();
        })
        .on('--help', function () {
            console.log('')
            console.log('Examples:');
            console.log('  $ dalao-proxy init'.gray);
            console.log('  $ dalao-proxy mock get'.gray);
            console.log('  $ dalao-proxy start -C ./my-config.json -p 1234 -wc'.gray);
            console.log('  $ dalao-proxy start -p 9090 -h test.dalao-proxy.com -wc'.gray);
            console.log('  $ dalao-proxy start --port=9090 --host=test.dalao-proxy.com --watch --cache=true'.gray);
            console.log('  $ dalao-proxy add-plugin @calvin_von/proxy-plugin-monitor'.gray);
        });
});

ConfigParser.parse(program);

if (!program.context.command) {
    program.outputHelp();
    process.exit(1);
}

// user runtime input listener
rl.on('line', runtimeCmd => {
    register.emit('input', runtimeCmd);

    if (/\b(restart|rs|reload)\b/.test(runtimeCmd)) {
        console.clear();
        console.log('\n> dalao is reloading...'.green);

        proxySever.close(function () {
            ConfigParser.parse(program);
        });
    }
    // else if (/\b(cacheclr|clean|cacheclean)\b/.test(runtimeCmd)) {
    //     CleanCache(runtimeConfig);
    // }
});

// process error caughtor
process.on('uncaughtException', function (err) {
    if (/(ECONNREFUSED|ECONNRESET)/i.test(err.message)) {
        console.log('\n> ðŸ˜«  Oops, dalao can\'t proxy to target'.red);
        console.error(err.message);
    }
    else {
        console.log('\n> ðŸ˜«  Oops, dalao can\'t handle this...'.red);
        console.error(err);
        console.log(`
    Current version: ${baseConfig.version}
    You may need to: 1.Update to the latest version by \`(sudo) npm i dalao-proxy@latest -g\`. 2.Look up your config file, check
    if there is any syntax problem(s). 3.Create a bug issue on https://github.com/CalvinVon/dalao-proxy/issues.
    dalao is sorry about this.`.yellow
        );
    }
});